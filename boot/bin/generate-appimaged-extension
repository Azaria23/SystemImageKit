#!/bin/bash

# To test:
# systemctl --user status appimaged
# systemctl --user enable appimaged
# systemctl --user start appimaged

set -e

HERE="$(dirname "$(readlink -f "${0}")")"

if [ -e /usr/bin/apt-get ] ; then
  which mksquashfs || apt-get -y install squashfs-tools
  which wget || apt-get -y install wget
  # which dpkg || apt-get -y install dpkg
fi

if [ -e /usr/bin/yum ] ; then
  which mksquashfs || yum -y install squashfs-tools
  which wget || yum -y install wget
  # which dpkg || yum -y install dpkg
fi

mkdir -p /tmp/appimaged_x86_64
cd /tmp/appimaged_x86_64

# wget -c http://ftp.us.debian.org/debian/pool/main/i/inotify-tools/libinotifytools0_3.14-1_amd64.deb
# dpkg -x libinotifytools*.deb .
# rm *.deb

# The following directories must exist when the session starts, otherwise the user must log out and in
# for appimaged to work properly. This is NOT an appimaged bug. Send a pull request if you can fix this.
mkdir -p etc/skel/.icons
echo "This directory must exist before the session starts in order to work" >> etc/skel/.icons/.note
mkdir -p etc/skel/.local/share/icons/hicolor/48x48/
echo "This directory must exist before the session starts in order to work" >> etc/skel/.local/share/icons/hicolor/48x48/.note
mkdir -p etc/skel/.local/share/applications/appimagekit
echo "This directory must exist before the session starts in order to work" >> etc/skel/.local/share/applications/appimagekit/.note
mkdir -p etc/skel/.local/share/mime/packages/
echo "This directory must exist before the session starts in order to work" >> etc/skel/.local/share/mime/packages/.note

mkdir -p usr/bin

# Get the ID of the last successful build on Travis CI
ID=$(wget -q https://api.travis-ci.org/repos/probonopd/appimagetool/builds -O - | head -n 1 | sed -e 's|}|\n|g' | grep '"result":0' | head -n 1 | sed -e 's|,|\n|g' | grep '"id"' | cut -d ":" -f 2)
# Get the transfer.sh URL from the logfile of the last successful build on Travis CI
# Only Travis knows why build ID and job ID don't match and why the above doesn't give both...
URL=$(wget -q "https://s3.amazonaws.com/archive.travis-ci.org/jobs/$((ID+1))/log.txt" -O - | grep "https://transfer.sh/.*/appimaged" | tail -n 1 | sed -e 's|\r||g')
if [ -z "$URL" ] ; then
  URL=$(wget -q "https://s3.amazonaws.com/archive.travis-ci.org/jobs/$((ID+2))/log.txt" -O - | grep "https://transfer.sh/.*/appimaged" | tail -n 1 | sed -e 's|\r||g')
fi
wget -c "$URL" -O usr/bin/appimaged
chmod a+x usr/bin/appimaged

mkdir -p usr/lib/systemd/user/
cat > usr/lib/systemd/user/appimaged.service<<\EOF
[Unit]
Description=AppImage daemon
After=basic.target

[Service]
ExecStart=/usr/bin/appimaged
Restart=always
RestartSec=5s
StartLimitInterval=0

[Install]
WantedBy=graphical.target
EOF

# Install AppImageUpdate to usr/local/bin
APP=AppImageUpdate
nodeFileName=$(wget -q "https://bintray.com/package/files/probono/AppImages/$APP?order=desc&sort=fileLastModified&basePath=&tab=files" -O - | grep -e '-x86_64.AppImage">' | cut -d '"' -f 6 | head -n 1)
wget -c "https://bintray.com/$nodeFileName" -O "$APP"
chmod a+x "$APP"
mkdir -p usr/local/bin/
sudo mv "$APP" usr/local/bin/

mkdir -p "${HERE}/../customize/x86_64/"
mksquashfs . "${HERE}/../customize/x86_64/appimaged.ExtensionImage" -noappend
cd -
