#!/bin/bash

LOCALE="de_DE.UTF-8" # Format: "de_DE.UTF-8"
LOCALE_NODOT=$(echo $LOCALE | cut -d "." -f 1) # Format: "de_DE"
KEYBOARD="de" # Format: "de"
TIMEZONE="Europe/Berlin" # Format: "Europe/Berlin"
USERNAME="me" # Format: "me"
HOSTNAME="host" # Format: "host"

HERE=$(dirname $(readlink -f $0))
. "$HERE"/detect_debian_live.sh
. "$HERE"/detect_arch.sh

if [[ $EUID -ne 0 ]]; then
  echo "You must be a root user" 2>&1
  exit 1
fi

function finish {
  umount /opt 2>/dev/null
  gsettings set org.gnome.desktop.media-handling automount 'true'
}
trap finish EXIT 

# Temporarily disable GNOME automount
# also for Unity in Ubuntu 11.04 and later
gsettings set org.gnome.desktop.media-handling automount 'false'

echo "# Automatically generated" > /tmp/grub.cfg

# TODO: Better autodetect, or detect target disk based on the location of this script
LIVE=$(mount | grep vfat | cut -d " " -f 3)
mount "$LIVE" -o remount,rw
ISOS=$(find $LIVE/boot/iso -name "*.iso")

for ISO in $ISOS; do
  unset LIVETOOL
  unset LIVETOOLVERSION
  unset LINUX
  unset INITRD
  unset APPEND
  mount "$ISO" /opt -oloop,ro
  ISONAME=$(basename "$ISO")

  detect_debian_live "/opt" >/dev/null
  detect_arch "/opt" # >/dev/null

  sleep 0.1
  umount /opt
  [[ -z $LIVETOOL || -z $LIVETOOL || -z $LINUX || -z $INITRD || -z $APPEND || -z $GRUBENTRY ]] && continue
  echo "$ISONAME"
  echo "$LIVETOOL"
  echo "$LIVETOOLVERSION"
  echo "$LINUX"
  echo "$INITRD"
  echo "$APPEND"
  # echo "$GRUBENTRY"
  echo ""

  ISONAME=$(basename "$ISO")

  echo "$GRUBENTRY" >> /tmp/grub.cfg
  echo "" >> /tmp/grub.cfg

done

grub-script-check /tmp/grub.cfg

